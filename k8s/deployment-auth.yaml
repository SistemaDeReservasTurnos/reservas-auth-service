apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-auth
  namespace: StudioBarber
  labels:
    app: reservas-auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reservas-auth-service
  template:
    metadata:
      labels:
        app: reservas-auth-service
    spec:
      serviceAccountName: auth-all-permissions-ksa #vinculaciÃ³n con la GSA
      containers:
        - name: reservas-auth-service
          # nombre local de la imagen -> auth-service-local:latest (igual siempre)
          image: us-central1-docker.pkg.dev/studiobarber-480215/repo-auth/auth-service:v1.0.0
          imagePullPolicy: Always  # nos aseguramos que siempre use la ultima version de la imagen
          ports:
            - containerPort: 8081
              protocol: TCP
          env:
            - name: DB_HOST
              value: 127.0.0.1 # La aplicaciÃ³n se conecta al sidecar
            - name: DB_PORT
              value: 5432     # Puerto que usa el sidecar
            - name: DB_USER   # El user es el email del GSA
              value: "auth-permisos@studiobarber-480215.iam.gserviceaccount.com"

          ## sidecar del proxy cloud sql auth
        - name: cloudsql-proxy
          image: gcr.io/cloudsql-docker/gce-proxy:1.33.0 #-> image oficial del proxy
          securityContext:
            runAsNonRoot: true
          command:

            - "/cloud_sql_proxy"
            - "-instances"

            # 3. ESPECIFICAR LA CADENA DE CONEXIÃ“N DE LA DB REMOTA (Proyecto BD)

            - "evocative-ethos-476120-h8:us-central1:reservasdb=tcp:5432"

            # 4. HABILITAR EL USO DE LAS CREDENCIALES DE LA KSA/GSA

            - "-enable_iam_login"

            # 5. Modo de autorizaciÃ³n predeterminado para Workload Identity
            - "-term_timeout=30s"


# cambios en el codigo = nueva imagen = nueva version vX.0.0
# pasos para subir a Artifact Registry
# 1. docker build -t auth-service-local:latest . -> contruir imagen local
# 2. docker tag auth-service-local:latest us-central1-docker.pkg.dev/studiobarber-480215/repo-auth/auth-service:v1.0.1 -> tag para subir a AR
# 3. docker push us-central1-docker.pkg.dev/studiobarber-480215/repo-auth/auth-service:v1.0.0 -> subir imagen